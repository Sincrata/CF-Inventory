<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Inventory</title>
  <link rel="icon" href="Planet.ico">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="Planet.ico">
  <style>
	.img-layer {
    		position: relative;
		width: 100%;
	}
	.img-layer .base {
    		display: block;
    		width: 100%;
    		height: auto;
	}
	.img-layer .top {
    		position: absolute;
    		top: 50%;
    		left: 50%;
    		transform: translate(-50%, -50%);
		width: 35%;
    		height: auto;
	}
	#myo-grid, #trait-grid, #voucher-grid {
    		display: grid;
    		grid-template-columns: repeat(auto-fill, 280px);
    		gap: 1rem;
    		justify-content: center;
	}


	.myo, .trait, .voucher { 
		width: 280px; 
		background: #582a98; 
		padding: 1rem; 
		display: flex; 
		flex-direction: column; 
		justify-content: center; 
		align-items: center;
		border-radius: 10px;}
	.loading {
    		width: 100%;
    		padding: 1.5rem;
    		background: #582a98;
    		text-align: center;
    		box-sizing: border-box;
		border-radius: 10px;
	}


	.myo-image, .trait-image, .voucher-image{
    		width: 100%;
    		height: auto;
    		display: block;
    		border-radius: 6px;
	}

	.myo-title, .trait-title, .voucher-title, .loading h4{
    		margin: 0.5rem 0;
    		font-size: 1.2rem;
		text-align: center;
	}

	.myo-info p, .trait-info p, .voucher-info p{
    		margin: 0;
    		font-size: 0.9rem;
		text-align: center;
	}
	.collapsible {
    		cursor: pointer;
    		display: flex;
    		align-items: center;
    		gap: 0.5rem;
	}
	.arrow {
    		transition: transform 0.2s ease;
	}
	.collapsed .arrow {
    		transform: rotate(-90deg);
	}
	.collapsible-content {
    		display: block;
	}
	.collapsed + .collapsible-content {
    		display: none;
	}


  </style>
</head>
<body>
	<header id="header">
		<div class="img-layer">
    			<img style="width: 100%;" src="bannerBG.png" class="base">
    			<a href="https://toyhou.se/~world/53663.the-candyfloss"><img src="bannerGIF.gif" class="top"></a>
		</div>


    		<nav>
        		<ul id="button-bar">
            			<li><a href="index.html">Home</a></li>
            			<li><a href="https://toyhou.se/~world/53663.the-candyfloss">World</a></li>
        		</ul>
    		</nav>
	</header>
	<main>
		<div id="onto-inventory" style="display: none;">
			<h1>Enter Username</h1>
			<hr>
			<input class="input" id="username" type="text" placeholder="Enter Username..."></input>
			<br>
			<button id="inventory-button" class="btn" style="width: 75%;" disabled>Go To Inventory</button>
		</div>
		<div id="inventory">
			<h1 id="title"> X's Inventory</h1>
			<hr>

			<article id="myos">
				<div id="myo-header" class="collapsible"><span class="arrow">▼</span><h2>MYOs</h2></div>
				<div id="myo-body" class="collapsible-content">
					<div id="myo-loading" class="loading"><h4>Loading Myos</h4></div>
					<div id="myo-grid">
					</div>
				</div>
			</article>


			<article id="traits">
				<div id="traits-header" class="collapsible"><span class="arrow">▼</span><h2>Traits & Packs</h2></div>
				<div id="traits-body" class="collapsible-content">
					<div id="trait-loading" class="loading"><h4>Loading Traits</h4></div>
					<div id="trait-grid">
					</div>
				</div>
			</article>

			<article id="vouchers">
				<div id="vouchers-header" class="collapsible"><span class="arrow">▼</span><h2>Redesign Vouchers: $0</h2></div>
				<div id="vouchers-body" class="collapsible-content">
					<div id="voucher-loading" class="loading"><h4>Loading Vouchers</h4></div>
					<div id="voucher-grid">
					</div>
				</div>
			</article>
		</div>
	
	</main>
	<script>
	async function main() {
		const params = new URLSearchParams(window.location.search);
		var username = params.get("username") ?? "";

		if(username ==""){
			const button = document.getElementById("onto-inventory");
			const inventory = document.getElementById("inventory");
			button.style.display = "block";
			inventory.style.display = "none";


			const invbtn = document.getElementById("inventory-button");
			username = document.getElementById("username");

			var userinput = username.value;

			username.addEventListener("keyup", () => {
				if(username.value.length > 0){
					invbtn.disabled = false;
				}else{
					invbtn.disabled = true;
				}
				userinput = username.value;
			});

			invbtn.addEventListener("click", () => {
    				const encoded = encodeURIComponent(userinput);
				window.location.href = `inventory.html?username=${encoded}`;
			});
		}
		
		document.querySelectorAll(".collapsible").forEach(header => {
    			header.addEventListener("click", () => {
        			header.classList.toggle("collapsed");
    			});
		});



		function capitalizeFirstWord(str) {
    			if (!str) return "";
    			const [first, ...rest] = str.trim().split(/\s+/);
    			return first.charAt(0).toUpperCase() + first.slice(1).toLowerCase() + 
           			(rest.length ? " " + rest.join(" ") : "");
		}
		
		username = capitalizeFirstWord(username);

		
		const title = document.getElementById("title");
		title.innerHTML = `${username}'s Inventory`;


		async function fetchCSV(url) {
    			const res = await fetch(url);
    			const text = await res.text();
    			return text;
		}

		function parseCSV(text) {
    			return text
        		.trim()
        		.split(/\r?\n/)
        		.map(line =>
            			line
                	.split(",")
                	.map(cell => cell.replace(/^"|"$/g, "")) // strip surrounding quotes
        		);
		}

		function filterRows(rows, colAName, colAValue, colBName, colBValue) {
    			const header = rows[0];
    			const data = rows.slice(1);

    			const colAIndex = header.indexOf(colAName);
    			const colBIndex = header.indexOf(colBName);

    			if (colAIndex === -1 || colBIndex === -1) {
        		console.error("Column name not found in header:", { header, colAName, colBName });
        		return [];
    			}

    			const maxIndex = Math.max(colAIndex, colBIndex);

    			return data.filter(row => {
        			if (!row || row.length <= maxIndex) {
            			// too short to safely read both columns → ignore
            			return false;
        			}

        			const a = row[colAIndex];
        			const b = row[colBIndex];

        			if (a == null || b == null) {
            				return false;
        			}

        			return a.toLowerCase() === colAValue.toLowerCase() &&
               			b.toLowerCase() === colBValue.toLowerCase();
    			});
		}

	
		function filterRows2(rows, colAName, colAValue, colBName, colBValue) {
    			const header = rows[0];
    			const data = rows.slice(1);

    			const colAIndex = header.indexOf(colAName);
    			const colBIndex = header.indexOf(colBName);

    			if (colAIndex === -1 || colBIndex === -1) {
        		console.error("Column name not found in header:", { header, colAName, colBName });
        		return [];
    			}

    			const maxIndex = Math.max(colAIndex, colBIndex);

    			return data.filter(row => {
        			if (!row || row.length <= maxIndex) {
            			// too short to safely read both columns → ignore
            			return false;
        		}

        		const a = row[colAIndex];
        		const b = row[colBIndex];

        		if (a == null || b == null) {
            			return false;
        		}

        		return a.toLowerCase() === colAValue.toLowerCase() &&
               		b.toLowerCase() !== colBValue.toLowerCase();
    			});
		}

		async function loadFilteredMYOData() {
    			const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRclpELOsw7e_9hsNHgafNBOtAwe76GOxPDX5rvX243m7Q6W8hqOTsw7k8kIEvOZKJSQTVOsuXmwCyK/pub?gid=1756069810&single=true&output=csv";

    			const csv = await fetchCSV(url);
    			const rows = parseCSV(csv);

    			const results = filterRows(
        			rows,
        			"Username",  username,
        			"Used", "unused"
    			);

    			console.log(results);
			return results;
		}

		const myos = await loadFilteredMYOData();

		var html = "";

		for (let i = 0; i < myos.length; i++) { 
			const myo = myos[i]
			if (myo[4].toLowerCase().includes("admin") || myo[4].toLowerCase().includes("contributor")) { 
				html += `<div class="myo"> 
				<img class="myo-image" src="${myo[3]}">
				<h4 class="myo-title">${capitalizeFirstWord(myo[4])} #${myo[2]}</h4>
				<div class="myo-info">
					<p>From: ${myo[5]}</p>
					<p>Date: ${myo[6]}</p>
				</div>
				</div>
			
				`;
			}else{
				html += `<div class="myo"> 
				<img class="myo-image" src="${myo[3]}">
				<h4 class="myo-title">${capitalizeFirstWord(myo[4])}</h4>
				<div class="myo-info">
					<p>From: ${myo[5]} #${myo[2]}</p>
					<p>Date: ${myo[6]}</p>
				</div>
				</div>
			
				`;
			}
		}

		
		const myogrid = document.getElementById("myo-grid");
		if(html == ""){
			html = `<div class="myo" style="width: 100%;"> <h4 class="myo-title">No Unused MYOs Found</h4></div>`;
			myogrid.style.gridTemplateColumns = "repeat(auto-fit, minmax(250px, 1fr))";
		}
		
		var loading = document.getElementById("myo-loading");
		loading.style.display = "none";

		myogrid.innerHTML = html;

		async function loadFilteredTraitData() {
    			const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRclpELOsw7e_9hsNHgafNBOtAwe76GOxPDX5rvX243m7Q6W8hqOTsw7k8kIEvOZKJSQTVOsuXmwCyK/pub?gid=677812775&single=true&output=csv";

    			const csv = await fetchCSV(url);
    			const rows = parseCSV(csv);

    			const results = filterRows(
        			rows,
        			"Username",  username,
        			"Used", ""
    			);

    			console.log(results);
			return results;
		}

		const traits = await loadFilteredTraitData();
		
		html = "";
		

		for (let i = 0; i < traits.length; i++) { 
			const trait = traits[i]
			html += `<div class="trait"> 
			<img class="trait-image" src="${trait[2]}">
			<h4 class="trait-title">${trait[3]}</h4>
			<div class="trait-info">
				<p>From: ${trait[4]}</p>
				<p>Date: ${trait[5]}</p>
			</div>
			</div>
			
			`;
		}

		
		const traitgrid = document.getElementById("trait-grid");
		if(html == ""){
			html = `<div class="trait" style="width: 100%"> <h4 class="trait-title">No Unused Traits Found</h4></div>`;
			traitgrid.style.gridTemplateColumns = "repeat(auto-fit, minmax(250px, 1fr))";
		}
		
		loading = document.getElementById("trait-loading");
		loading.style.display = "none";
		

		traitgrid.innerHTML = html;



		async function loadFilteredVoucherData() {
    			const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRclpELOsw7e_9hsNHgafNBOtAwe76GOxPDX5rvX243m7Q6W8hqOTsw7k8kIEvOZKJSQTVOsuXmwCyK/pub?gid=1273044878&single=true&output=csv";

    			const csv = await fetchCSV(url);
    			const rows = parseCSV(csv);

    			const results = filterRows2(
        			rows,
        			"Username",  username,
        			"Remaining", "0"
    			);

    			console.log(results);
			return results;
		}

		const vouchers = await loadFilteredVoucherData();
		
		html = "";

		var total = 0;
		

		for (let i = 0; i < vouchers.length; i++) { 
			const voucher = vouchers[i]
			total += parseFloat(voucher[5], 10);
			html += `<div class="voucher"> 
			<img class="voucher-image" src="${voucher[2]}">
			<h4 class="voucher-title">$${voucher[3]} Redesign Voucher</h4>
			<div class="voucher-info">
				<p>Used: $${voucher[4]}</p>
				<p>Remaining: $${voucher[5]}</p>
				<p>From: ${voucher[6]}</p>
				<p>Date: ${voucher[7]}</p>
			</div>
			</div>
			
			`;
		}

		
		const vouchergrid = document.getElementById("voucher-grid");
		if(html == ""){
			html = `<div class="voucher" style="width: 100%"> <h4 class="voucher-title">No Unused Vouchers Found</h4></div>`;
			vouchergrid.style.gridTemplateColumns = "repeat(auto-fit, minmax(250px, 1fr))";
		}
		
		loading = document.getElementById("voucher-loading");
		loading.style.display = "none";

		vouchergrid.innerHTML = html;

		const counter = document.getElementById("vouchers-header");
		
		counter.innerHTML = `<span class="arrow">▼</span><h2>Redesign Vouchers: $${total}</h2>`;
	}
	main();
	
	</script>
</body>
</html>